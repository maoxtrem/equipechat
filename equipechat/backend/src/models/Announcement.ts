// src/models/Announcement.ts - VersÃ£o atualizada
import {
  Table,
  Column,
  CreatedAt,
  UpdatedAt,
  Model,
  PrimaryKey,
  AutoIncrement,
  DataType,
  BelongsTo,
  ForeignKey,
  Default
} from "sequelize-typescript";
import Company from "./Company";

@Table
class Announcement extends Model<Announcement> {
  @PrimaryKey
  @AutoIncrement
  @Column
  id: number;

  @Column
  priority: number; //1 - alta, 2 - mÃ©dia, 3 - baixa

  @Column
  title: string;

  @Column(DataType.TEXT)
  text: string;

  @Column
  get mediaPath(): string | null {
    if (this.getDataValue("mediaPath")) {
      return `${process.env.BACKEND_URL}${process.env.PROXY_PORT ?`:${process.env.PROXY_PORT}`:""}/public/announcements/${this.getDataValue("mediaPath")}`;
    }
    return null;
  }

  @Column
  mediaName: string;

  @ForeignKey(() => Company)
  @Column
  companyId: number;

  // ðŸŽ¯ NOVA FUNCIONALIDADE: Informativo por empresa especÃ­fica
  @ForeignKey(() => Company)
  @Column
  targetCompanyId: number; // NULL = todas as empresas, especÃ­fico = apenas essa empresa

  // ðŸŽ‚ NOVA FUNCIONALIDADE: Tipo do informativo
  @Default('general')
  @Column(DataType.ENUM('general', 'birthday', 'system'))
  type: 'general' | 'birthday' | 'system';

  // ðŸ¤– NOVA FUNCIONALIDADE: Informativo automÃ¡tico
  @Default(false)
  @Column
  isAutoGenerated: boolean;

  // â° NOVA FUNCIONALIDADE: Data de expiraÃ§Ã£o
  @Column
  expiresAt: Date;

  @Column
  status: boolean;

  @CreatedAt
  createdAt: Date;

  @UpdatedAt
  updatedAt: Date;

  @BelongsTo(() => Company)
  company: Company;

  @BelongsTo(() => Company, 'targetCompanyId')
  targetCompany: Company;

  /**
   * Cria um informativo de aniversÃ¡rio automaticamente
   */
  static async createBirthdayAnnouncement(
    companyId: number, 
    targetCompanyId: number | null, 
    user: any
  ): Promise<Announcement> {
    const expiresAt = new Date();
    expiresAt.setDate(expiresAt.getDate() + 1); // Expira em 24h

    return Announcement.create({
      companyId,
      targetCompanyId,
      type: 'birthday',
      isAutoGenerated: true,
      priority: 2, // MÃ©dia prioridade
      title: `ðŸŽ‰ AniversÃ¡rio de ${user.name}!`,
      text: `Hoje Ã© aniversÃ¡rio do nosso colega ${user.name}! ðŸŽ‚\n\nVamos parabenizar e desejar muito sucesso e felicidade! ðŸŽ‰âœ¨`,
      status: true,
      expiresAt
    });
  }

  /**
   * Remove informativos expirados automaticamente
   */
  static async cleanExpiredAnnouncements(): Promise<number> {
    const result = await Announcement.destroy({
      where: {
        isAutoGenerated: true,
        expiresAt: {
          [require('sequelize').Op.lt]: new Date()
        }
      }
    });

    return result;
  }

  /**
   * Busca informativos para uma empresa especÃ­fica
   */
  static async getAnnouncementsForCompany(userCompanyId: number): Promise<Announcement[]> {
    return Announcement.findAll({
      where: {
        status: true,
        [require('sequelize').Op.or]: [
          { targetCompanyId: null }, // Informativos globais
          { targetCompanyId: userCompanyId } // Informativos especÃ­ficos da empresa
        ],
        [require('sequelize').Op.or]: [
          { expiresAt: null }, // Informativos sem expiraÃ§Ã£o
          { expiresAt: { [require('sequelize').Op.gt]: new Date() } } // Informativos nÃ£o expirados
        ]
      },
      include: [
        { model: Company, as: "company", attributes: ["id", "name"] },
        { model: Company, as: "targetCompany", attributes: ["id", "name"] }
      ],
      order: [
        ['priority', 'ASC'],
        ['createdAt', 'DESC']
      ]
    });
  }
}

export default Announcement;